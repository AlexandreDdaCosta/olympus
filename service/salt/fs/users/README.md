# olympus user structure

Several categories of users exist under olympus. Different management steps
apply to the different types of users.

Broadly speaking, users are defined as *human* or *system*.

Note that many of the following details can be deduced by examining the
relevant state file for users. See *service/salt/fs/users.sls* in this
repository.

All users appear in [SaltStack pillar](https://docs.saltproject.io/en/latest/topics/tutorials/pillar.html)
in **users.sls**. This pillar file contains only two specifications:

* **groups**. Defines system groups that exist on all servers. Each group
imparts specific privileges which are detailed in *users.sls*.

* **users**. The complete list of users added beyond those created by
the core Debian installation or added Debian packages.

Since olympus is built on Linux, these designations should be understood to
refer to the group/user Linux hierarchy system. 

## Human users

### Unprivileged

A pillar entry for an unprivileged user could include the following settings:

```
someuser:
  class: human
  comment: Some person
  createhome: True
  edit_precommand: sed -i 's/\/var\/lib\/someuser/\/home\/someuser/' /etc/passwd
  email_address: some.olympus.user@gmail.com
  fullname: Some User
  groups:
    - clientcert
    - servercert
  mongodb:
    admin: True
  redis:
    keys:
      - securities:equities
    password: {{ salt['cmd.shell'](random_password_generator) }}
  restapi:
    password: {{ salt['cmd.shell'](random_password_generator) }}
    routes:
      /equities/:
        - GET
      /token/equities/:
        - GET
  server:
    - interface
  shell: /bin/false
  ssh_public_key: ssh-ed25519 AAAAsNzDpSDMoLPhX6FeepkwOfud8VswKjYD2T6dotreJi29eUBxvCLwq0Pk7l5xdSaz some.olympus.user@gmail.com
  vimuser: True
```

The various definitions have the following functions:

* **class**. Identifies the type of user -- *human* in this case. Exists mostly
documentation purposes. However, if no shell is assigned to a human user, then
*/bin/bash* will be assigned by default.
* **comment**. Optional informative details.
* **createhome**. When set to "True", this will create a home directory for the
user on every olympus server.
* **edit_precommand**. Stores a system command that gets executed prior to
account creation and before regular account maintenance via Salt states.
* **email_address**. Contact email address. Updates to this address require
an update in salt pillar.
* **fullname**. The user's proper name. For documentation purposes.
* **groups**. Adds user membership to the listed groups under Linux. By
default, the only group added will be the user's own group, which matches the
user's ID.
* **mongodb**. Details user roles and permissions in mongodb. All server types
run an instance of mongodb, typically as a form of short-term storage for
data too complex for simple key/value types (for a discussion of storage for
key/value pairs, see the **redis** section below). Two specifications are
available, **admin** and **roles**.  If *admin* is *True* (as in the example
above), the user will have full administrative access to mongodb. If *roles* is
defined (as in the system users example below), user access will be limited to
the specified collections and operations. User passwords for mongodb are
randomly generated and regularly regenerated, with SaltStack maintaining a
current password file in *~/etc/mongodb_password* on those servers on which the
user has an account and home directory.
* **redis**. Enables redis access on the local server. A *password*
specification is **mandatory**. In order to comply with system security
standards, this password should be randomly generated by SaltStack. The
specification shown above fulfills this requirement. Running the
*security.sls* state file will update these passwords for all users on each
targeted server. If **createhome** is set to **True**, a copy of the
updated password gets placed in the user's home directory at 
*~/etc/redis_password*. This operation also depends on the specification for
**server** *(see below)*. To limit the keys available to the user, define
those under the *keys* specification as shown above. Without the *keys*
limitation, a local redis user will **only** have access to keys prefixed with
the user's ID and a colon, which is the default access and is available to all
users with redis access.
* **restapi**. Enables access to the REST back end. As with the *redis* 
specification, a password is required and follows the same rules. Also
relevant are the redis rules regarding **createhome**, **server**, and the
running of *security.sls*, including the placement of a reference password file
in *~/etc/restapi_password*. If *routes* is specified, the user's API access
will be limited to the indicated root paths and verbs. Without the *routes*
specification, the user will have unlimited access to all API endpoints.
* **server**. If specified, user accounts will only be provisioned on the
listed server types. Without this specification, the user will have accounts
on all local server types.
* **shell**. If specified, the user account will use the indicated Linux
shell. The default is [bash](https://www.gnu.org/software/bash/).
* **ssh_public_key**. If specified, the listed public SSH key will be
installed in *~/.ssh* within each of the user's home directories. This is a
key feature for user access to olympus since password access is not available.
* **vimuser**. This setting only applies to users with accounts in the
development environment. When set to "True", olympus will install a
pre-packaged [vim](https://www.vim.org/) development bundle.

In addition, the following future designation is foreseen:

* **disable: True**. Maintains the user's account on the system, including user
directories, but removes user access. This means that added groups are 
removed, the contents of ~/.ssh are deleted, access to redis, mongodb, and the
backend API is revoked, and the user will no longer have access to the web UI.

To completely remove user accounts and their associated data, a special Salt
state is foreseen. Note that user accounts will **never** be removed from the
front-end database; they will be deactivated, with all user data kept as a
permanent archive.

### Staff

As the name implies, **staff** users are system administrators. A typical entry
in pillar for such a user can look almost the same as for an unprivileged user
*except* for the following differences:

```
staffuser:
  ...
  is_staff: True
  ...
  original_interface_password: S0meranD0mP4sSw0Rd
  ...
```

**is_staff**. Identifies the user as an administrator. This has numerous
side effects:

* The user will have supervisor and staff privileges on the web UI.
* Enables sudoers privileges on all servers containing a user account.
* Enables git access, meaning that the user will have code development
privileges.
* Enables redis access on all servers, including read/write access to all
keys. A password is still required.
* Enables full administrative access to the local mongodb server via
password access.
* Enables full access to the backend REST API via password access.

**original_interface_password**. An initial password used when creating a staff
user account for accessing the web UI. For security, a member of the staff is
encouraged to change this password immediately upon first login. *This 
suggestion will shortly become an enforced requirement*. Without this
specification, the initial UI password will be randomly assigned, which is
probably undesirable as the password would then be unknown and therefore
unusable. Note that the password can still be set with Django's management
command-line interface using *manage.py* and the *verifyuser* option.

## System users

These are non-human users, typically the IDs under which system services
will run. A typical configuration would be as follows:

```
  olympus:
    class: system
    createhome: True
    fullname: Olympus system run user
    groups:
      - clientcert
    mongodb:
      roles:
        - equities: readWrite
        - user:olympus: readWrite
    redis:
      keys:
        - securities:equities
      password: {{ salt['cmd.shell'](random_password_generator) }}
    restapi:
      password: {{ salt['cmd.shell'](random_password_generator) }}
      routes:
        /equities/:
          - GET
        /token/equities/:
          - GET
    server:
      - interface
      - supervisor
      - unified
      - worker
    shell: /bin/false
```

The available specifications have the same purpose as those for *human* users,
although some would serve little or no purpose, such as *email_address* and
*vimuser*. Settings like *ssh_public_key* and *is_staff* would pose a
systemic risk as they would allow capabilities that should not be available to
system users.

* **class**. A system user would have a class designation of *system*. If no
shell is assigned to a system user, the default will be */usr/sbin/nologin*.
According to the Debian convention, when a system user is provisioned, that
user will be assigned a UID in the range of FIRST_SYSTEM_UID and
LAST_SYSTEM_UID,
